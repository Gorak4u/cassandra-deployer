// Jenkinsfile.rolling_restart
// Performs a safe, rolling restart of the Cassandra service.

pipeline {
    agent any

    environment {
        SCRIPTS_PATH = '/Users/ggonda/cassandra-tools/scripts'
        // Add common binary paths for macOS to help find 'qv'
        PATH = "/usr/local/bin:/opt/homebrew/bin:${env.PATH}"
    }

    parameters {
        string(name: 'QV_QUERY', defaultValue: '-r role_cassandra_pfpt -d AWSLAB', description: 'The qv query to select target nodes for the rolling restart.')
    }

    stages {
        stage('Execute Rolling Restart') {
            steps {
                sshagent(credentials: ['your-jenkins-ssh-key-id']) {
                    sh """
                        chmod +x ${env.SCRIPTS_PATH}/cassy.sh
                        ${env.SCRIPTS_PATH}/cassy.sh --rolling-op restart --qv-query "${params.QV_QUERY}"
                    """
                }
            }
        }
    }
}
