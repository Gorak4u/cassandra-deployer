class cassandra_pfpt (
  String $cassandra_version,
  String $java_version,
  Optional[String] $java_package_name,
  Boolean $manage_repo,
  String $user,
  String $group,
  Optional[String] $repo_baseurl,
  Optional[String] $repo_gpgkey,
  Boolean $repo_gpgcheck,
  Integer $repo_priority,
  Boolean $repo_skip_if_unavailable,
  Boolean $repo_sslverify,
  Array[String] $package_dependencies,
  String $cluster_name,
  Array[String] $seeds_list = [],
  String $listen_address,
  String $datacenter,
  String $rack,
  String $data_dir,
  String $saved_caches_dir,
  String $commitlog_dir,
  String $hints_directory,
  String $config_dir_path,
  String $max_heap_size,
  String $gc_type,
  Hash $extra_jvm_args_override = {},
  Sensitive[String] $cassandra_password,
  String $replace_address,
  Boolean $disable_swap,
  Hash $sysctl_settings,
  Hash $limits_settings,
  String $manage_bin_dir,
  String $jamm_source,
  String $jamm_target,
  Boolean $use_shenandoah_gc,
  Hash $racks,
  Boolean $ssl_enabled,
  String $https_domain,
  String $target_dir,
  String $keystore_path,
  Sensitive[String] $keystore_password,
  String $truststore_path,
  Sensitive[String] $truststore_password,
  String $internode_encryption,
  Boolean $internode_require_client_auth,
  Boolean $client_optional,
  Boolean $client_require_client_auth,
  String $client_keystore_path,
  Sensitive[String] $client_keystore_password,
  String $client_truststore_path,
  Sensitive[String] $client_truststore_password,
  String $tls_protocol,
  String $tls_algorithm,
  String $store_type,
  Integer $concurrent_compactors,
  Integer $compaction_throughput_mb_per_sec,
  Integer $tombstone_warn_threshold,
  Integer $tombstone_failure_threshold,
  String $change_password_cql,
  String $cqlsh_path_env,
  Boolean $dynamic_snitch,
  Boolean $start_native_transport,
  String $role_manager,
  String $cdc_raw_directory,
  String $commit_failure_policy,
  String $commitlog_sync,
  String $disk_failure_policy,
  Boolean $incremental_backups,
  Integer $max_hints_delivery_threads,
  Boolean $native_transport_flush_in_batches_legacy,
  Integer $native_transport_max_frame_size_in_mb,
  Integer $range_request_timeout_in_ms,
  Integer $read_request_timeout_in_ms,
  Integer $request_timeout_in_ms,
  Integer $ssl_storage_port,
  Integer $storage_port,
  Integer $truncate_request_timeout_in_ms,
  Integer $write_request_timeout_in_ms,
  Integer $commitlog_sync_period_in_ms,
  Boolean $start_rpc,
  Integer $rpc_port,
  Boolean $rpc_keepalive,
  Integer $thrift_framed_transport_size_in_mb,
  Boolean $enable_transient_replication,
  Boolean $enable_materialized_views,
  Boolean $manage_jmx_security,
  String $jmx_password_file_content,
  String $jmx_access_file_content,
  String $jmx_password_file_path,
  String $jmx_access_file_path,
  String $service_timeout_start_sec,
  String $service_restart,
  Integer $service_restart_sec,
  Optional[String] $authorizer,
  Optional[String] $authenticator,
  Optional[Integer] $num_tokens,
  Optional[String] $initial_token,
  Optional[String] $endpoint_snitch,
  Optional[String] $listen_interface,
  Optional[String] $rpc_interface,
  Optional[String] $broadcast_address,
  Optional[String] $broadcast_rpc_address,
  Optional[Integer] $counter_cache_size_in_mb,
  Optional[Integer] $key_cache_size_in_mb,
  Optional[String] $disk_optimization_strategy,
  Optional[Boolean] $auto_snapshot,
  Optional[Integer] $phi_convict_threshold,
  Optional[Integer] $concurrent_reads,
  Optional[Integer] $concurrent_writes,
  Optional[Integer] $concurrent_counter_writes,
  Optional[String] $memtable_allocation_type,
  Optional[Integer] $index_summary_capacity_in_mb,
  Optional[Integer] $file_cache_size_in_mb,
  Boolean $manage_coralogix_agent,
  String $coralogix_api_key,
  String $coralogix_region,
  Boolean $coralogix_logs_enabled,
  Boolean $coralogix_metrics_enabled,
  String $coralogix_application_name,
  String $coralogix_subsystem_name,
  Hash $coralogix_log_files,
  Array[String] $coralogix_jmx_metrics,
  String $coralogix_jmx_endpoint,
  Optional[String] $coralogix_baseurl = undef,
  Hash $system_keyspaces_replication = {},
  Hash $schema_users = {},
  Hash $schema_keyspaces = {},
  Hash $schema_tables = {},
  Hash $schema_cql_types = {},
  Boolean $manage_jmx_exporter,
  String $jmx_exporter_version,
  String $jmx_exporter_jar_source,
  String $jmx_exporter_jar_target,
  String $jmx_exporter_config_source,
  String $jmx_exporter_config_target,
  Integer $jmx_exporter_port,
  Boolean $manage_full_backups = false,
  Boolean $manage_incremental_backups = false,
  String $full_backup_schedule = 'daily',
  String $incremental_backup_schedule = '0 */4 * * *',
  String $backup_s3_bucket = 'your-s3-backup-bucket',
  String $full_backup_script_path = '/usr/local/bin/full-backup-to-s3.sh',
  String $incremental_backup_script_path = '/usr/local/bin/incremental-backup-to-s3.sh',
  String $full_backup_log_file = '/var/log/cassandra/full_backup.log',
  String $incremental_backup_log_file = '/var/log/cassandra/incremental_backup.log',
  String $backup_backend = 's3',
  Integer $clearsnapshot_keep_days = 3,
  Boolean $backup_upload_streaming = false,
  Integer $backup_parallelism = 4,
  Integer $s3_retention_period = 15,
  Array[String] $backup_exclude_keyspaces = [],
  Array[String] $backup_exclude_tables = [],
  Array[String] $backup_include_only_keyspaces = [],
  Array[String] $backup_include_only_tables = [],
  Boolean $manage_scheduled_repair = false,
  String $repair_schedule = '*-*-1/5 01:00:00',
  Optional[String] $repair_keyspace = undef,
  Sensitive[String] $backup_encryption_key,
  Boolean $manage_stress_test = false,
  Boolean $manage_node_exporter = false,
  String $node_exporter_version = '1.7.0',
  Optional[String] $node_exporter_download_url_base = undef,
  String $node_exporter_install_method = 'url',
  String $node_exporter_package_name = 'node_exporter',
  String $node_exporter_package_ensure = 'installed',
  String $node_exporter_user = 'node_exporter',
  String $node_exporter_group = 'node_exporter',
  String $node_exporter_install_dir = '/var/lib/node_exporter',
  String $node_exporter_bin_dir = '/usr/local/bin',
  # Puppet Agent Management
  Boolean $manage_puppet_agent_cron = false,
  String $puppet_cron_schedule_string = '*/30 * * * *'
) {
  # Validate Java and Cassandra version compatibility
  $cassandra_major_version = split($cassandra_version, '[.-]')[0]
  if (Integer($cassandra_major_version) == 4 and Integer($java_version) < 11) or
     (Integer($cassandra_major_version) >= 5 and Integer($java_version) < 11) {
    fail("Cassandra version ${cassandra_version} requires Java 11 or newer, but Java ${java_version} was specified.")
  }

  # If seed list is empty, default to self-seeding. This is crucial for bootstrapping.
  $seeds = if empty($seeds_list) {
    [$facts['networking']['ip']]
  } else {
    $seeds_list
  }

  # Calculate default JVM args based on GC type and Java version
  $default_jvm_args_hash = if $gc_type == 'G1GC' and versioncmp($java_version, '8') >= 0 {
    {
      'G1RSetUpdatingPauseTimePercent' => '-XX:G1RSetUpdatingPauseTimePercent=5',
      'MaxGCPauseMillis'               => '-XX:MaxGCPauseMillis=500',
      'InitiatingHeapOccupancyPercent' => '-XX:InitiatingHeapOccupancyPercent=70',
      'ParallelRefProcEnabled'         => '-XX:+ParallelRefProcEnabled',
      'PerfDisableSharedMem'           => '-XX:+PerfDisableSharedMem',
      'AlwaysPreTouch'                 => '-XX:+AlwaysPreTouch',
    }
  } elsif $gc_type == 'CMS' and versioncmp($java_version, '14') < 0 {
    # CMS is deprecated and removed in Java 14. This only applies to older Java versions.
    {
      'UseConcMarkSweepGC'             => '-XX:+UseConcMarkSweepGC',
      'CMSParallelRemarkEnabled'       => '-XX:+CMSParallelRemarkEnabled',
      'SurvivorRatio'                  => '-XX:SurvivorRatio=8',
      'MaxTenuringThreshold'           => '-XX:MaxTenuringThreshold=1',
      'CMSInitiatingOccupancyFraction' => '-XX:CMSInitiatingOccupancyFraction=75',
      'UseCMSInitiatingOccupancyOnly'  => '-XX:+UseCMSInitiatingOccupancyOnly',
      'CMSClassUnloadingEnabled'       => '-XX:+CMSClassUnloadingEnabled',
      'AlwaysPreTouch'                 => '-XX:+AlwaysPreTouch',
    }
  } else {
    {}
  }

  # Merge the default arguments with any overrides from Hiera. Hiera wins.
  $merged_jvm_args_hash = $default_jvm_args_hash + $extra_jvm_args_override
  $extra_jvm_args = $merged_jvm_args_hash.values

  # Centralized SSL flag for cqlsh commands
  $cqlsh_ssl_opt = $ssl_enabled ? {
    true  => '--ssl',
    false => '',
  }

  contain cassandra_pfpt::java
  contain cassandra_pfpt::install
  contain cassandra_pfpt::config
  contain cassandra_pfpt::service
  contain cassandra_pfpt::firewall
  contain cassandra_pfpt::system_keyspaces
  contain cassandra_pfpt::schema

  if $manage_node_exporter {
    contain cassandra_pfpt::node_exporter
  }
  if $manage_jmx_exporter {
    contain cassandra_pfpt::jmx_exporter
  }
  if $manage_coralogix_agent {
    contain cassandra_pfpt::coralogix
    Class['cassandra_pfpt::config'] -> Class['cassandra_pfpt::coralogix']
  }
  if $manage_full_backups or $manage_incremental_backups {
    contain cassandra_pfpt::backup
  }
  if $manage_scheduled_repair {
    contain cassandra_pfpt::repair
  }
  if $manage_puppet_agent_cron {
    contain 'cassandra_pfpt::puppet_agent'
  }
  if $manage_stress_test {
    class { 'cassandra_pfpt::stress':
      user        => $user,
      password    => $cassandra_password,
      ssl_enabled => $ssl_enabled,
    }
    Class['cassandra_pfpt::install'] -> Class['cassandra_pfpt::stress']
  }
  if $ssl_enabled {
    contain cassandra_pfpt::ssl
    Class['cassandra_pfpt::java']
    -> Class['cassandra_pfpt::install']
    -> Class['cassandra_pfpt::ssl']
    -> Class['cassandra_pfpt::config']
    ~> Class['cassandra_pfpt::service']
  } else {
    Class['cassandra_pfpt::java']
    -> Class['cassandra_pfpt::install']
    -> Class['cassandra_pfpt::config']
    ~> Class['cassandra_pfpt::service']
  }
}
