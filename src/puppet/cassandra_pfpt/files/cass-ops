#!/usr/bin/env bash
# This file is managed by Puppet.
#
# cass-ops: A unified operational wrapper for Cassandra.
# This script provides a single entry point for various management
# tasks, adding safety checks and simplifying complex commands.

set -euo pipefail

# --- Color Codes ---
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
BOLD='\033[1m'
NC='\033[0m' # No Color

# --- Base Directory for Scripts ---
SCRIPT_DIR="/usr/local/bin"

# --- Help Function ---
show_help() {
(
cat <<EOF
${BOLD}Usage: cass-ops <command> [options]${NC}

Unified operations script for Cassandra.

${YELLOW}Available Commands:${NC}
  {health,cluster-health,disk-health,version,stop,restart,reboot,drain,decommission,replace,rebuild,repair,cleanup,compact,garbage-collect,upgrade-sstables,backup,incremental-backup,backup-status,backup-verify,snapshot,restore,assassinate,stress,manual,upgrade-check,backup-guide,puppet-guide}

${GREEN}Health & Status:${NC}
  ${BOLD}health${NC}              Run a comprehensive health check on the local node.
  ${BOLD}cluster-health${NC}      Quickly check cluster connectivity and nodetool status.
  ${BOLD}disk-health${NC}         Check disk usage against warning/critical thresholds.
  ${BOLD}version${NC}             Audit and print versions of key software (OS, Java, Cassandra).
  ${BOLD}backup-status${NC}       Check the status of the last completed backup for a node.

${GREEN}Node & Service Lifecycle:${NC}
  ${BOLD}stop${NC}                Safely drain and stop the Cassandra service.
  ${BOLD}restart${NC}             Perform a safe, rolling restart of the Cassandra service.
  ${BOLD}reboot${NC}              Safely drain Cassandra and reboot the machine.
  ${BOLD}drain${NC}               Drain the node, flushing memtables and stopping client traffic.
  ${BOLD}decommission${NC}        Permanently remove this node from the cluster after streaming its data.
  ${BOLD}replace${NC}             Configure this NEW, STOPPED node to replace a dead node.
  ${BOLD}assassinate${NC}         Forcibly remove a dead node from the cluster's gossip ring.

${GREEN}Data & Maintenance Operations:${NC}
  ${BOLD}rebuild${NC}             Rebuild the data on this node by streaming from another datacenter.
  ${BOLD}repair${NC}              Run a safe, manual full repair on the node. Can target a specific keyspace/table.
  ${BOLD}cleanup${NC}             Run 'nodetool cleanup' with safety checks.
  ${BOLD}compact${NC}             Run 'nodetool compact' with safety checks and advanced options.
  ${BOLD}garbage-collect${NC}     Run 'nodetool garbagecollect' with safety checks.
  ${BOLD}upgrade-sstables${NC}    Run 'nodetool upgradesstables' with safety checks.
  ${BOLD}upgrade-check${NC}       Run pre-flight checks before a major version upgrade.

${GREEN}Backup & Recovery:${NC}
  ${BOLD}backup${NC}              Manually trigger a full, node-local backup to S3.
  ${BOLD}incremental-backup${NC}  Manually trigger an incremental backup to S3.
  ${BOLD}backup-verify${NC}       Verify the integrity and restorability of the latest backup set.
  ${BOLD}snapshot${NC}            Take an ad-hoc snapshot with a generated tag.
  ${BOLD}restore${NC}             Restore data from S3. Run without arguments for an interactive wizard.

${GREEN}Tooling & Documentation:${NC}
  ${BOLD}stress${NC}              Run 'cassandra-stress' via a robust wrapper.
  ${BOLD}manual${NC}              Display the full operations manual in the terminal.
  ${BOLD}backup-guide${NC}        Display the full backup and recovery guide.
  ${BOLD}puppet-guide${NC}        Display the Puppet architecture guide.

Run 'cass-ops <command> -h' for more information on a specific command.
EOF
) | less -R
}

# --- Main Command Router ---
if [ "$#" -eq 0 ]; then
    show_help
    exit 0
fi

# The main command is the first argument
COMMAND=$1

# Handle a global help request
if [ "$COMMAND" = "-h" ] || [ "$COMMAND" = "--help" ]; then
    show_help
    exit 0
fi

# The script to execute, defaults to the command name with a .sh extension
# This allows for commands like 'health' to map to 'node_health_check.sh'
SCRIPT_NAME="${COMMAND}.sh"

case "$COMMAND" in
    health)
        SCRIPT_NAME="node_health_check.sh"
        ;;
    restart)
        SCRIPT_NAME="rolling_restart.sh"
        ;;
    stop)
        SCRIPT_NAME="stop-node.sh"
        ;;
    reboot)
        SCRIPT_NAME="reboot-node.sh"
        ;;
    replace)
        SCRIPT_NAME="prepare-replacement.sh"
        ;;
    repair)
        SCRIPT_NAME="full-repair.sh"
        ;;
    cleanup)
        SCRIPT_NAME="cleanup-node.sh"
        ;;
    compact)
        SCRIPT_NAME="compaction-manager.sh"
        ;;
    garbage-collect)
        SCRIPT_NAME="garbage-collect.sh"
        ;;
    upgrade-sstables)
        SCRIPT_NAME="upgrade-sstables.sh"
        ;;
    backup)
        SCRIPT_NAME="full-backup-to-s3.sh"
        ;;
    incremental-backup)
        SCRIPT_NAME="incremental-backup-to-s3.sh"
        ;;
    backup-status)
        SCRIPT_NAME="backup-status.sh"
        ;;
    backup-verify)
        SCRIPT_NAME="verify-backup.sh"
        ;;
    restore)
        SCRIPT_NAME="restore-from-s3.sh"
        ;;
    snapshot)
        SCRIPT_NAME="take-snapshot.sh"
        ;;
    assassinate)
        SCRIPT_NAME="assassinate-node.sh"
        ;;
    stress)
        SCRIPT_NAME="stress-test.sh"
        ;;
    manual)
        SCRIPT_NAME="cassandra-manual.sh"
        ;;
    upgrade-check)
        SCRIPT_NAME="cassandra-upgrade-precheck.sh"
        ;;
    backup-guide)
        less -R "/usr/share/doc/cassandra_pfpt/BACKUP_AND_RECOVERY_GUIDE.md"
        exit 0
        ;;
    puppet-guide)
        less -R "/usr/share/doc/cassandra_pfpt/PUPPET_ARCHITECTURE_GUIDE.md"
        exit 0
        ;;
    -h|--help)
        show_help
        exit 0
        ;;
    *)
        # Check if a script with that name exists. If so, we'll run it.
        # If not, it's an unknown command.
        if [ ! -f "${SCRIPT_DIR}/${SCRIPT_NAME}" ]; then
            echo -e "${RED}Error: Unknown command '$COMMAND'${NC}" >&2
            echo "Run 'cass-ops --help' for a list of available commands." >&2
            exit 1
        fi
        ;;
esac

# The script to be executed is at SCRIPT_DIR/SCRIPT_NAME
TARGET_SCRIPT="${SCRIPT_DIR}/${SCRIPT_NAME}"

# Shift away the main command so the rest of the arguments are passed to the target script
shift

# Check if the target script exists and is executable
if [ -x "$TARGET_SCRIPT" ]; then
    # Pass all remaining arguments to the target script
    "$TARGET_SCRIPT" "$@"
else
    echo -e "${RED}Error: Command script for '$COMMAND' not found or not executable at '$TARGET_SCRIPT'${NC}" >&2
    exit 127
fi
