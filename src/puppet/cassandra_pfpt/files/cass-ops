#!/usr/bin/env bash
# This file is managed by Puppet.
#
# cass-ops: Unified operations script for Cassandra.
#
# This script acts as a single, user-friendly entry point for the suite of
# more complex operational scripts located in this directory. It provides
# simple, memorable commands and detailed help text.

set -euo pipefail

# --- Color Codes ---
RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
BOLD='\033[1m'
NC='\033[0m' # No Color

# --- Help Text Function ---
show_help() {
    echo -e "${BOLD}Usage: cass-ops [-h] <command> ...${NC}"
    echo -e ""
    echo -e "Unified operations script for Cassandra."
    echo -e ""
    echo -e "${YELLOW}Available Commands:${NC}"
    
    # Use a temporary file to format with column
    local temp_file
    temp_file=$(mktemp)
    
    # List of commands and their descriptions, separated by a tab
    cat > "$temp_file" <<-EOF
health	Run a comprehensive health check on the local node.
cluster-health	Quickly check cluster connectivity and nodetool status.
disk-health	Check disk usage against warning/critical thresholds.
version	Audit and print versions of key software (OS, Java, Cassandra).
stop	Safely drain and stop the Cassandra service.
restart	Perform a safe, rolling restart of the Cassandra service.
reboot	Safely drain Cassandra and reboot the machine.
drain	Drain the node, flushing memtables and stopping client traffic.
decommission	Permanently remove this node from the cluster after streaming its data.
replace	Configure this NEW, STOPPED node to replace a dead node.
rebuild	Rebuild the data on this node by streaming from another datacenter.
repair	Run a safe, manual full repair on the node. Can target a specific keyspace/table.
cleanup	Run 'nodetool cleanup' with safety checks.
compact	Run 'nodetool compact' with safety checks and advanced options.
garbage-collect	Run 'nodetool garbagecollect' with safety checks.
upgrade-sstables	Run 'nodetool upgradesstables' with safety checks.
backup	Manually trigger a full, node-local backup to S3.
incremental-backup	Manually trigger an incremental backup to S3.
backup-status	Check the status of the last completed backup for a node.
snapshot	Take an ad-hoc snapshot with a generated tag.
restore	Restore data from S3. Run without arguments for an interactive wizard.
assassinate	Forcibly remove a dead node from the cluster's gossip ring.
stress	Run 'cassandra-stress' via a robust wrapper.
manual	Display the full operations manual in the terminal.
upgrade-check	Run pre-flight checks before a major version upgrade.
backup-guide	Display the full backup and recovery guide.
puppet-guide	Display the Puppet architecture guide.
EOF
    
    # Print formatted help text
    column -t -s $'\t' "$temp_file"
    rm "$temp_file"

    echo ""
    echo -e "${YELLOW}optional arguments:${NC}"
    echo "  -h, --help            show this help message and exit"
    echo ""
    echo -e "Run 'cass-ops <command> -h' for more information on a specific command."
}


# --- Main Script Logic ---

# If no command is given, show help
if [ -z "${1:-}" ]; then
    show_help
    exit 1
fi

# Store the command
COMMAND="$1"

# Handle help flag
if [[ "$COMMAND" == "-h" || "$COMMAND" == "--help" ]]; then
    show_help
    exit 0
fi

# The script must be run as root
if [ "$(id -u)" -ne 0 ]; then
  echo -e "${RED}Error: This script must be run as root or with sudo.${NC}" >&2
  exit 1
fi

# --- Command Router ---
case "$COMMAND" in
    health)
        shift
        /usr/local/bin/node_health_check.sh "$@"
        ;;
    cluster-health)
        shift
        /usr/local/bin/cluster-health.sh "$@"
        ;;
    disk-health)
        shift
        /usr/local/bin/disk-health-check.sh "$@"
        ;;
    version)
        shift
        /usr/local/bin/version-check.sh "$@"
        ;;
    stop)
        shift
        /usr/local/bin/stop-node.sh "$@"
        ;;
    restart)
        shift
        /usr/local/bin/rolling_restart.sh "$@"
        ;;
    reboot)
        shift
        /usr/local/bin/reboot-node.sh "$@"
        ;;
    drain)
        shift
        /usr/local/bin/drain-node.sh "$@"
        ;;
    decommission)
        shift
        /usr/local/bin/decommission-node.sh "$@"
        ;;
    replace)
        shift
        /usr/local/bin/prepare-replacement.sh "$@"
        ;;
    rebuild)
        shift
        /usr/local/bin/rebuild-node.sh "$@"
        ;;
    repair)
        shift
        /usr/local/bin/full-repair.sh "$@"
        ;;
    cleanup)
        shift
        # Pass all subsequent arguments to the script
        /usr/local/bin/cleanup-node.sh "$@"
        ;;
    compact)
        shift
        /usr/local/bin/compaction-manager.sh "$@"
        ;;
    garbage-collect)
        shift
        /usr/local/bin/garbage-collect.sh "$@"
        ;;
    upgrade-sstables)
        shift
        /usr/local/bin/upgrade-sstables.sh "$@"
        ;;
    backup)
        shift
        /usr/local/bin/full-backup-to-s3.sh "$@"
        ;;
    incremental-backup)
        shift
        /usr/local/bin/incremental-backup-to-s3.sh "$@"
        ;;
    backup-status)
        shift
        /usr/local/bin/backup-status.sh "$@"
        ;;
    snapshot)
        shift
        /usr/local/bin/take-snapshot.sh "$@"
        ;;
    restore)
        shift
        /usr/local/bin/restore-from-s3.sh "$@"
        ;;
    assassinate)
        shift
        /usr/local/bin/assassinate-node.sh "$@"
        ;;
    stress)
        shift
        /usr/local/bin/stress-test.sh "$@"
        ;;
    manual)
        /usr/local/bin/cassandra-manual.sh
        ;;
    upgrade-check)
        /usr/local/bin/cassandra-upgrade-precheck.sh
        ;;
    backup-guide)
        if [ -f /usr/share/doc/cassandra_pfpt/BACKUP_AND_RECOVERY_GUIDE.md ]; then
            less -R /usr/share/doc/cassandra_pfpt/BACKUP_AND_RECOVERY_GUIDE.md
        else
            echo "Backup guide not found."
        fi
        ;;
    puppet-guide)
        if [ -f /usr/share/doc/cassandra_pfpt/PUPPET_ARCHITECTURE_GUIDE.md ]; then
            less -R /usr/share/doc/cassandra_pfpt/PUPPET_ARCHITECTURE_GUIDE.md
        else
            echo "Puppet guide not found."
        fi
        ;;
    *)
        echo -e "${RED}Error: Unknown command '$COMMAND'${NC}" >&2
        echo ""
        show_help
        exit 1
        ;;
esac

exit $?
