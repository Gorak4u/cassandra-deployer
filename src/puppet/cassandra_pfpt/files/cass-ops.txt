#!/bin/bash
# This file is managed by Puppet.
set -euo pipefail

# --- Color Codes ---
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
BOLD='\033[1m'
NC='\033[0m' # No Color

# --- Help Function ---
usage() {
    cat << EOF
${BOLD}Cassandra Operations Master Script${NC}

A unified wrapper for managing common Cassandra operational tasks on this node.

${YELLOW}Usage: $0 <command> [arguments...]${NC}

${BLUE}COMMANDS:${NC}

  ${BOLD}STATUS & HEALTH CHECKS${NC}
    ${GREEN}health${NC}                 Run a comprehensive health check on the local node.
    ${GREEN}cluster-health${NC}          Quickly check cluster connectivity and nodetool status.
    ${GREEN}disk-health${NC}             Check disk usage against warning/critical thresholds.
    ${GREEN}version${NC}                 Audit and print versions of key software (OS, Java, Cassandra).
    ${GREEN}upgrade-check${NC}          Run pre-flight checks before a major version upgrade.

  ${BOLD}NODE LIFECYCLE & MAINTENANCE${NC}
    ${GREEN}stop${NC}                   Safely drain and stop the Cassandra service.
    ${GREEN}restart${NC}                Perform a safe, rolling restart of the Cassandra service.
    ${GREEN}reboot${NC}                 Safely drain Cassandra and reboot the machine.
    ${GREEN}drain${NC}                  Drain the node, flushing memtables and stopping client traffic.
    ${GREEN}decommission${NC}           Permanently remove this node from the cluster after streaming its data.
    ${GREEN}replace${NC} <dead_node_ip>  Configure this NEW, STOPPED node to replace a dead node.
    ${GREEN}rebuild${NC} <source_dc>     Rebuild the data on this node by streaming from another datacenter.

  ${BOLD}DATA MANAGEMENT & REPAIR${NC}
    ${GREEN}repair${NC} [<keyspace>]     Run a safe, granular repair on the node's token ranges. Can target a specific keyspace.
    ${GREEN}cleanup${NC} [opts]          Run 'nodetool cleanup' with safety checks.
    ${GREEN}compact${NC} [opts]          Run 'nodetool compact' with safety checks.
    ${GREEN}garbage-collect${NC} [opts]  Run 'nodetool garbagecollect' with safety checks.
    ${GREEN}upgrade-sstables${NC} [opts] Run 'nodetool upgradesstables' with safety checks.

  ${BOLD}BACKUP & RECOVERY${NC}
    ${GREEN}backup${NC}                  Manually trigger a full, node-local backup to S3.
    ${GREEN}incremental-backup${NC}      Manually trigger an incremental backup to S3.
    ${GREEN}backup-status${NC}          Check the status of the last completed backup for a node.
    ${GREEN}snapshot${NC} [<keyspaces>]  Take an ad-hoc snapshot with a generated tag.
    ${GREEN}restore${NC} [opts]          Restore data from S3, list backups, or show restore chains.

  ${BOLD}DOCUMENTATION${NC}
    ${GREEN}manual${NC}                 Display the full operations manual in the terminal.
    ${GREEN}backup-guide${NC}           Display the full backup and recovery guide.
    ${GREEN}puppet-guide${NC}           Display the Puppet architecture guide.

  ${BOLD}ADVANCED & DESTRUCTIVE (USE WITH CAUTION!)${NC}
    ${GREEN}assassinate${NC} <dead_node_ip> Forcibly remove a dead node from the cluster's gossip ring.

  ${BOLD}PERFORMANCE TESTING${NC}
    ${GREEN}stress${NC} [opts]            Run 'cassandra-stress' via a robust wrapper.

  ${BOLD}HELP${NC}
    ${GREEN}-h, --help${NC}              Show this help message.

EOF
    exit 1
}

if [ "$#" -eq 0 ]; then
    usage
fi

COMMAND="$1"
shift # Remove the command from the argument list

# The main dispatcher
case "$COMMAND" in
    health)
        /usr/local/bin/node_health_check.sh "$@"
        ;;
    cluster-health)
        /usr/local/bin/cluster-health.sh "$@"
        ;;
    disk-health)
        /usr/local/bin/disk-health-check.sh "$@"
        ;;
    version)
        /usr/local/bin/version-check.sh "$@"
        ;;
    stop)
        /usr/local/bin/stop-node.sh "$@"
        ;;
    restart)
        /usr/local/bin/rolling_restart.sh "$@"
        ;;
    reboot)
        /usr/local/bin/reboot-node.sh "$@"
        ;;
    drain)
        /usr/local/bin/drain-node.sh "$@"
        ;;
    decommission)
        /usr/local/bin/decommission-node.sh "$@"
        ;;
    replace)
        /usr/local/bin/prepare-replacement.sh "$@"
        ;;
    rebuild)
        /usr/local/bin/rebuild-node.sh "$@"
        ;;
    upgrade-check)
        /usr/local/bin/cassandra-upgrade-precheck.sh "$@"
        ;;
    repair)
        /usr/local/bin/range-repair.sh "$@"
        ;;
    cleanup)
        /usr/local/bin/cleanup-node.sh "$@"
        ;;
    compact)
        /usr/local/bin/compaction-manager.sh "$@"
        ;;
    garbage-collect)
        /usr/local/bin/garbage-collect.sh "$@"
        ;;
    upgrade-sstables)
        /usr/local/bin/upgrade-sstables.sh "$@"
        ;;
    backup)
        /usr/local/bin/full-backup-to-s3.sh "$@"
        ;;
    incremental-backup)
        /usr/local/bin/incremental-backup-to-s3.sh "$@"
        ;;
    backup-status)
        /usr/local/bin/backup-status.sh "$@"
        ;;
    snapshot)
        /usr/local/bin/take-snapshot.sh "$@"
        ;;
    restore)
        /usr/local/bin/restore-from-s3.sh "$@"
        ;;
    assassinate)
        /usr/local/bin/assassinate-node.sh "$@"
        ;;
    stress)
        /usr/local/bin/stress-test.sh "$@"
        ;;
    manual)
        /usr/local/bin/cassandra-manual.sh "$@"
        ;;
    backup-guide)
        less -R /usr/share/doc/cassandra_pfpt/BACKUP_AND_RECOVERY_GUIDE.md
        ;;
    puppet-guide)
        less -R /usr/share/doc/cassandra_pfpt/PUPPET_ARCHITECTURE_GUIDE.md
        ;;
    help|--help|-h)
        usage
        ;;
    *)
        echo -e "${RED}Error: Unknown command '$COMMAND'${NC}"
        echo ""
        usage
        ;;
esac
