
# @summary Profile for managing a complete Cassandra node.
class profile_cassandra_pfpt (
  String $cassandra_version               = '4.1.10-1',
  String $java_version                    = '11',
  Optional[String] $java_package_name     = undef,
  Boolean $manage_repo                   = true,
  String $user                            = 'cassandra',
  String $group                           = 'cassandra',
  String $repo_baseurl                    = 'https://debian.cassandra.apache.org',
  String $repo_gpgkey                     = 'https://downloads.apache.org/cassandra/KEYS',
  Boolean $repo_gpgcheck                  = true,
  Integer $repo_priority                 = 1,
  Boolean $repo_skip_if_unavailable      = false,
  Boolean $repo_sslverify                 = true,
  Array[String] $package_dependencies     = ['cyrus-sasl-plain', 'jemalloc', 'python3', 'numactl', 'jq', 'awscli'],
  String $cluster_name                    = 'pfpt-cassandra-cluster',
  Array[String] $seeds_list               = [],
  String $listen_address                  = $facts['networking']['ip'],
  String $datacenter                      = 'dc1',
  String $rack                            = 'rack1',
  String $data_dir                        = '/var/lib/cassandra/data',
  String $saved_caches_dir                = '/var/lib/cassandra/saved_caches',
  String $commitlog_dir                   = '/var/lib/cassandra/commitlog',
  String $hints_directory                 = '/var/lib/cassandra/hints',
  String $max_heap_size                   = '3G',
  String $gc_type                         = 'G1GC',
  Hash $jvm_additional_opts              = {},
  String $cassandra_password              = 'PP#C@ss@ndr@000',
  String $replace_address                 = '',
  Boolean $disable_swap                  = true,
  Hash $sysctl_settings                   = { 'fs.aio-max-nr' => 1048576 },
  Hash $limits_settings                   = {
    'memlock' => 'unlimited',
    'nofile'  => 100000,
    'nproc'   => 32768,
    'as'      => 'unlimited'
  },
  String $manage_bin_dir                  = '/usr/local/bin',
  String $jamm_source                     = 'https://repo1.maven.org/maven2/com/github/jbellis/jamm/0.4.0/jamm-0.4.0.jar',
  String $jamm_target                     = '/usr/share/cassandra/lib/jamm-0.4.0.jar',
  Boolean $enable_range_repair           = true,
  Boolean $use_shenandoah_gc             = false,
  Hash $racks                             = {},
  Boolean $ssl_enabled                   = false,
  String $https_domain                    = $facts['networking']['fqdn'],
  String $target_dir                      = '/etc/cassandra/ssl',
  String $keystore_path                   = '/etc/cassandra/ssl/keystore.jks',
  String $keystore_password               = 'ChangeMe',
  String $truststore_path                 = '/etc/cassandra/ssl/truststore.jks',
  String $truststore_password             = 'changeit',
  String $internode_encryption            = 'all',
  Boolean $internode_require_client_auth = true,
  Boolean $client_optional               = false,
  Boolean $client_require_client_auth    = true,
  String $client_keystore_path            = '/etc/cassandra/ssl/client_keystore.jks',
  String $client_truststore_path          = '/etc/cassandra/ssl/client_truststore.jks',
  String $client_truststore_password      = 'changeit',
  String $tls_protocol                    = 'TLS',
  String $tls_algorithm                   = 'SunX509',
  String $store_type                      = 'JKS',
  Integer $concurrent_compactors         = 4,
  Integer $compaction_throughput_mb_per_sec = 16,
  Integer $tombstone_warn_threshold      = 1000,
  Integer $tombstone_failure_threshold   = 100000,
  String $change_password_cql             = "ALTER USER cassandra WITH PASSWORD '%s'",
  String $cqlsh_path_env                  = '/usr/bin',
  Boolean $dynamic_snitch                = true,
  Boolean $start_native_transport        = true,
  String $role_manager                    = 'CassandraRoleManager',
  String $cdc_raw_directory               = '/var/lib/cassandra/cdc_raw',
  String $commit_failure_policy           = 'stop',
  String $commitlog_sync                  = 'periodic',
  String $disk_failure_policy             = 'stop',
  Boolean $incremental_backups           = false,
  Integer $max_hints_delivery_threads    = 2,
  Boolean $native_transport_flush_in_batches_legacy = true,
  Integer $native_transport_max_frame_size_in_mb = 256,
  Integer $range_request_timeout_in_ms   = 10000,
  Integer $read_request_timeout_in_ms    = 2000,
  Integer $request_timeout_in_ms         = 10000,
  Integer $ssl_storage_port              = 7001,
  Integer $storage_port                  = 7000,
  Integer $truncate_request_timeout_in_ms = 60000,
  Integer $write_request_timeout_in_ms   = 2000,
  Integer $commitlog_sync_period_in_ms   = 10000,
  Boolean $start_rpc                     = true,
  Integer $rpc_port                      = 9160,
  Boolean $rpc_keepalive                 = true,
  Integer $thrift_framed_transport_size_in_mb = 15,
  Boolean $enable_transient_replication  = false,
  Boolean $manage_jmx_security           = true,
  String $jmx_password_file_content       = 'cassandra changeme',
  String $jmx_access_file_content         = 'cassandra readwrite',
  String $jmx_password_file_path          = '/etc/cassandra/jmxremote.password',
  String $jmx_access_file_path            = '/etc/cassandra/jmxremote.access',
  String $service_timeout_start_sec       = '180',
  Optional[String] $authorizer            = 'CassandraAuthorizer',
  Optional[String] $authenticator         = 'PasswordAuthenticator',
  Optional[Integer] $num_tokens           = 256,
  Optional[String] $initial_token         = undef,
  Optional[String] $endpoint_snitch       = 'GossipingPropertyFileSnitch',
  Optional[String] $listen_interface     = undef,
  Optional[String] $rpc_interface        = undef,
  Optional[String] $broadcast_address    = undef,
  Optional[String] $broadcast_rpc_address = undef,
  Optional[Integer] $counter_cache_size_in_mb = undef,
  Optional[Integer] $key_cache_size_in_mb = undef,
  Optional[String] $disk_optimization_strategy = 'ssd',
  Optional[Boolean] $auto_snapshot        = true,
  Optional[Integer] $phi_convict_threshold = 8,
  Optional[Integer] $concurrent_reads     = 32,
  Optional[Integer] $concurrent_writes    = 32,
  Optional[Integer] $concurrent_counter_writes = 32,
  Optional[String] $memtable_allocation_type = 'heap_buffers',
  Optional[Integer] $index_summary_capacity_in_mb = undef,
  Optional[Integer] $file_cache_size_in_mb = undef,
  Boolean $manage_coralogix_agent        = false,
  String $coralogix_api_key               = 'undefined',
  String $coralogix_region                = 'Europe',
  Boolean $coralogix_logs_enabled        = true,
  Boolean $coralogix_metrics_enabled     = true,
  Boolean $enable_materialized_views     = false,
  Optional[String] $coralogix_baseurl     = undef,
  Hash $system_keyspaces_replication      = {},
  Hash $cassandra_roles                   = {},
  Boolean $manage_jmx_exporter           = false,
  String $jmx_exporter_version            = '0.16.1',
  String $jmx_exporter_jar_source         = 'https://repo1.maven.org/maven2/io/prometheus/jmx/jmx_prometheus_javaagent/0.16.1/jmx_prometheus_javaagent-0.16.1.jar',
  String $jmx_exporter_jar_target         = '/usr/share/cassandra/lib/jmx_prometheus_javaagent.jar',
  String $jmx_exporter_config_source      = 'puppet:///modules/cassandra_pfpt/cassandra-jmx-exporter.yaml',
  String $jmx_exporter_config_target      = '/etc/cassandra/cassandra-jmx-exporter.yaml',
  Integer $jmx_exporter_port             = 9400,
  Boolean $manage_full_backups           = false,
  Boolean $manage_incremental_backups    = false,
  String $full_backup_schedule            = 'daily',
  Variant[String, Array[String]] $incremental_backup_schedule = '0 */4 * * *',
  String $backup_s3_bucket                = 'your-s3-backup-bucket',
  String $full_backup_script_path         = '/usr/local/bin/full-backup-to-s3.sh',
  String $incremental_backup_script_path  = '/usr/local/bin/incremental-backup-to-s3.sh',
  String $full_backup_log_file            = '/var/log/cassandra/full_backup.log',
  String $incremental_backup_log_file     = '/var/log/cassandra/incremental_backup.log',
  Optional[String] $puppet_cron_schedule  = undef,
  String $backup_backend                  = 's3',
  Integer $clearsnapshot_keep_days        = 3,
  Boolean $backup_upload_streaming       = false,
  Boolean $manage_scheduled_repair        = false,
  String $repair_schedule                 = '*-*-1/5 01:00:00',
  Optional[String] $repair_keyspace       = undef,
) {

  $extra_jvm_args = $jvm_additional_opts.map |$key, $value| {
    "-D${key}=${value}"
  }

  class { 'cassandra_pfpt':
    cassandra_version                  => $cassandra_version,
    java_version                       => $java_version,
    java_package_name                  => $java_package_name,
    manage_repo                        => $manage_repo,
    user                               => $user,
    group                              => $group,
    repo_baseurl                       => $repo_baseurl,
    repo_gpgkey                        => $repo_gpgkey,
    repo_gpgcheck                      => $repo_gpgcheck,
    repo_priority                      => $repo_priority,
    repo_skip_if_unavailable           => $repo_skip_if_unavailable,
    repo_sslverify                     => $repo_sslverify,
    package_dependencies               => $package_dependencies,
    cluster_name                       => $cluster_name,
    seeds_list                         => $seeds_list,
    listen_address                     => $listen_address,
    datacenter                         => $datacenter,
    rack                               => $rack,
    data_dir                           => $data_dir,
    saved_caches_dir                   => $saved_caches_dir,
    commitlog_dir                      => $commitlog_dir,
    hints_directory                    => $hints_directory,
    max_heap_size                      => $max_heap_size,
    gc_type                            => $gc_type,
    extra_jvm_args_override            => $jvm_additional_opts,
    cassandra_password                 => $cassandra_password,
    replace_address                    => $replace_address,
    disable_swap                       => $disable_swap,
    sysctl_settings                    => $sysctl_settings,
    limits_settings                    => $limits_settings,
    manage_bin_dir                     => $manage_bin_dir,
    jamm_source                        => $jamm_source,
    jamm_target                        => $jamm_target,
    enable_range_repair                => $enable_range_repair,
    use_shenandoah_gc                  => $use_shenandoah_gc,
    racks                              => $racks,
    ssl_enabled                        => $ssl_enabled,
    https_domain                       => $https_domain,
    target_dir                         => $target_dir,
    keystore_path                      => $keystore_path,
    keystore_password                  => $keystore_password,
    truststore_path                    => $truststore_path,
    truststore_password                => $truststore_password,
    internode_encryption               => $internode_encryption,
    internode_require_client_auth      => $internode_require_client_auth,
    client_optional                    => $client_optional,
    client_require_client_auth         => $client_require_client_auth,
    client_keystore_path               => $client_keystore_path,
    client_truststore_path             => $client_truststore_path,
    client_truststore_password         => $client_truststore_password,
    tls_protocol                       => $tls_protocol,
    tls_algorithm                      => $tls_algorithm,
    store_type                         => $store_type,
    concurrent_compactors              => $concurrent_compactors,
    compaction_throughput_mb_per_sec   => $compaction_throughput_mb_per_sec,
    tombstone_warn_threshold           => $tombstone_warn_threshold,
    tombstone_failure_threshold        => $tombstone_failure_threshold,
    change_password_cql                => $change_password_cql,
    cqlsh_path_env                     => $cqlsh_path_env,
    dynamic_snitch                     => $dynamic_snitch,
    start_native_transport             => $start_native_transport,
    role_manager                       => $role_manager,
    cdc_raw_directory                  => $cdc_raw_directory,
    commit_failure_policy              => $commit_failure_policy,
    commitlog_sync                     => $commitlog_sync,
    disk_failure_policy                => $disk_failure_policy,
    incremental_backups                => $incremental_backups,
    max_hints_delivery_threads         => $max_hints_delivery_threads,
    native_transport_flush_in_batches_legacy => $native_transport_flush_in_batches_legacy,
    native_transport_max_frame_size_in_mb => $native_transport_max_frame_size_in_mb,
    range_request_timeout_in_ms        => $range_request_timeout_in_ms,
    read_request_timeout_in_ms         => $read_request_timeout_in_ms,
    request_timeout_in_ms              => $request_timeout_in_ms,
    ssl_storage_port                   => $ssl_storage_port,
    storage_port                       => $storage_port,
    truncate_request_timeout_in_ms     => $truncate_request_timeout_in_ms,
    write_request_timeout_in_ms        => $write_request_timeout_in_ms,
    commitlog_sync_period_in_ms        => $commitlog_sync_period_in_ms,
    start_rpc                          => $start_rpc,
    rpc_port                           => $rpc_port,
    rpc_keepalive                      => $rpc_keepalive,
    thrift_framed_transport_size_in_mb => $thrift_framed_transport_size_in_mb,
    enable_transient_replication       => $enable_transient_replication,
    manage_jmx_security                => $manage_jmx_security,
    jmx_password_file_content          => $jmx_password_file_content,
    jmx_access_file_content            => $jmx_access_file_content,
    jmx_password_file_path             => $jmx_password_file_path,
    jmx_access_file_path               => $jmx_access_file_path,
    service_timeout_start_sec          => $service_timeout_start_sec,
    authorizer                         => $authorizer,
    authenticator                      => $authenticator,
    num_tokens                         => $num_tokens,
    initial_token                      => $initial_token,
    endpoint_snitch                    => $endpoint_snitch,
    listen_interface                   => $listen_interface,
    rpc_interface                      => $rpc_interface,
    broadcast_address                  => $broadcast_address,
    broadcast_rpc_address              => $broadcast_rpc_address,
    counter_cache_size_in_mb           => $counter_cache_size_in_mb,
    key_cache_size_in_mb               => $key_cache_size_in_mb,
    disk_optimization_strategy         => $disk_optimization_strategy,
    auto_snapshot                      => $auto_snapshot,
    phi_convict_threshold              => $phi_convict_threshold,
    concurrent_reads                   => $concurrent_reads,
    concurrent_writes                  => $concurrent_writes,
    concurrent_counter_writes          => $concurrent_counter_writes,
    memtable_allocation_type           => $memtable_allocation_type,
    index_summary_capacity_in_mb       => $index_summary_capacity_in_mb,
    file_cache_size_in_mb              => $file_cache_size_in_mb,
    manage_coralogix_agent             => $manage_coralogix_agent,
    coralogix_api_key                  => $coralogix_api_key,
    coralogix_region                   => $coralogix_region,
    coralogix_logs_enabled             => $coralogix_logs_enabled,
    coralogix_metrics_enabled          => $coralogix_metrics_enabled,
    enable_materialized_views          => $enable_materialized_views,
    coralogix_baseurl                  => $coralogix_baseurl,
    system_keyspaces_replication       => $system_keyspaces_replication,
    cassandra_roles                    => $cassandra_roles,
    manage_jmx_exporter                => $manage_jmx_exporter,
    jmx_exporter_version               => $jmx_exporter_version,
    jmx_exporter_jar_source            => $jmx_exporter_jar_source,
    jmx_exporter_jar_target            => $jmx_exporter_jar_target,
    jmx_exporter_config_source         => $jmx_exporter_config_source,
    jmx_exporter_config_target         => $jmx_exporter_config_target,
    jmx_exporter_port                  => $jmx_exporter_port,
    manage_full_backups                => $manage_full_backups,
    manage_incremental_backups         => $manage_incremental_backups,
    full_backup_schedule               => $full_backup_schedule,
    incremental_backup_schedule        => $incremental_backup_schedule,
    backup_s3_bucket                   => $backup_s3_bucket,
    full_backup_script_path            => $full_backup_script_path,
    incremental_backup_script_path     => $incremental_backup_script_path,
    full_backup_log_file               => $full_backup_log_file,
    incremental_backup_log_file        => $incremental_backup_log_file,
    puppet_cron_schedule               => $puppet_cron_schedule,
    backup_backend                     => $backup_backend,
    clearsnapshot_keep_days            => $clearsnapshot_keep_days,
    backup_upload_streaming            => $backup_upload_streaming,
    manage_scheduled_repair            => $manage_scheduled_repair,
    repair_schedule                    => $repair_schedule,
    repair_keyspace                    => $repair_keyspace,
  }
}
