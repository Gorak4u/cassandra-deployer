# @summary A profile class that wraps the cassandra_pfpt component.
# It sources its configuration from Hiera and passes it down.
class profile_cassandra_pfpt (
  Sensitive[String] $backup_encryption_key = lookup('profile_cassandra_pfpt::backup_encryption_key'),
  # Add other parameters that you want to control via Hiera
) {
  class { 'cassandra_pfpt':
    cassandra_version             => lookup('profile_cassandra_pfpt::cassandra_version', { default_value => '4.1.10-1' }),
    java_version                  => lookup('profile_cassandra_pfpt::java_version', { default_value => '11' }),
    java_package_name             => lookup('profile_cassandra_pfpt::java_package_name', { default_value => undef }),
    manage_repo                   => lookup('profile_cassandra_pfpt::manage_repo', { default_value => true }),
    user                          => lookup('profile_cassandra_pfpt::user', { default_value => 'cassandra' }),
    group                         => lookup('profile_cassandra_pfpt::group', { default_value => 'cassandra' }),
    repo_baseurl                  => lookup('profile_cassandra_pfpt::repo_baseurl', { default_value => "https://downloads.apache.org/cassandra/redhat/41x/" }),
    repo_gpgkey                   => lookup('profile_cassandra_pfpt::repo_gpgkey', { default_value => 'https://downloads.apache.org/cassandra/KEYS' }),
    repo_gpgcheck                 => lookup('profile_cassandra_pfpt::repo_gpgcheck', { default_value => true }),
    repo_priority                 => lookup('profile_cassandra_pfpt::repo_priority', { default_value => 1 }),
    repo_skip_if_unavailable      => lookup('profile_cassandra_pfpt::repo_skip_if_unavailable', { default_value => false }),
    repo_sslverify                => lookup('profile_cassandra_pfpt::repo_sslverify', { default_value => true }),
    package_dependencies          => lookup('profile_cassandra_pfpt::package_dependencies', { default_value => ['jq', 'awscli', 'openssl'] }),
    cluster_name                  => lookup('profile_cassandra_pfpt::cluster_name', { default_value => 'pfpt-cassandra-cluster' }),
    seeds_list                    => lookup('profile_cassandra_pfpt::seeds', { default_value => [] }),
    listen_address                => lookup('profile_cassandra_pfpt::listen_address', { default_value => $facts['networking']['ip'] }),
    datacenter                    => lookup('profile_cassandra_pfpt::datacenter', { default_value => 'dc1' }),
    rack                          => lookup('profile_cassandra_pfpt::rack', { default_value => 'rack1' }),
    data_dir                      => lookup('profile_cassandra_pfpt::data_dir', { default_value => '/var/lib/cassandra/data' }),
    saved_caches_dir              => lookup('profile_cassandra_pfpt::saved_caches_dir', { default_value => '/var/lib/cassandra/saved_caches' }),
    commitlog_dir                 => lookup('profile_cassandra_pfpt::commitlog_dir', { default_value => '/var/lib/cassandra/commitlog' }),
    hints_directory               => lookup('profile_cassandra_pfpt::hints_directory', { default_value => '/var/lib/cassandra/hints' }),
    max_heap_size                 => lookup('profile_cassandra_pfpt::max_heap_size', { default_value => '3G' }),
    gc_type                       => lookup('profile_cassandra_pfpt::gc_type', { default_value => 'G1GC' }),
    extra_jvm_args_override       => lookup('profile_cassandra_pfpt::jvm_additional_opts', { default_value => {} }),
    cassandra_password            => lookup('profile_cassandra_pfpt::cassandra_password', { default_value => 'PP#C@ss@ndr@000' }),
    replace_address               => lookup('profile_cassandra_pfpt::replace_address', { default_value => '' }),
    disable_swap                  => lookup('profile_cassandra_pfpt::disable_swap', { default_value => true }),
    sysctl_settings               => lookup('profile_cassandra_pfpt::sysctl_settings', { default_value => {} }),
    limits_settings               => lookup('profile_cassandra_pfpt::limits_settings', { default_value => {} }),
    manage_bin_dir                => lookup('profile_cassandra_pfpt::manage_bin_dir', { default_value => '/usr/local/bin' }),
    jamm_source                   => lookup('profile_cassandra_pfpt::jamm_source', { default_value => undef }),
    jamm_target                   => lookup('profile_cassandra_pfpt::jamm_target', { default_value => undef }),
    use_shenandoah_gc             => lookup('profile_cassandra_pfpt::use_shenandoah_gc', { default_value => false }),
    racks                         => lookup('profile_cassandra_pfpt::racks', { default_value => {} }),
    ssl_enabled                   => lookup('profile_cassandra_pfpt::ssl_enabled', { default_value => false }),
    https_domain                  => lookup('profile_cassandra_pfpt::https_domain', { default_value => $facts['networking']['fqdn'] }),
    target_dir                    => lookup('profile_cassandra_pfpt::target_dir', { default_value => '/etc/cassandra/conf' }),
    keystore_path                 => lookup('profile_cassandra_pfpt::keystore_path', { default_value => '/etc/cassandra/conf/keystore.jks' }),
    keystore_password             => lookup('profile_cassandra_pfpt::keystore_password', { default_value => 'cassandra' }),
    truststore_path               => lookup('profile_cassandra_pfpt::truststore_path', { default_value => '/etc/cassandra/conf/truststore.jks' }),
    truststore_password           => lookup('profile_cassandra_pfpt::truststore_password', { default_value => 'cassandra' }),
    internode_encryption          => lookup('profile_cassandra_pfpt::internode_encryption', { default_value => 'none' }),
    internode_require_client_auth => lookup('profile_cassandra_pfpt::internode_require_client_auth', { default_value => false }),
    client_optional               => lookup('profile_cassandra_pfpt::client_optional', { default_value => false }),
    client_require_client_auth    => lookup('profile_cassandra_pfpt::client_require_client_auth', { default_value => false }),
    client_keystore_path          => lookup('profile_cassandra_pfpt::client_keystore_path', { default_value => '/etc/cassandra/conf/client_keystore.jks' }),
    client_truststore_path        => lookup('profile_cassandra_pfpt::client_truststore_path', { default_value => '/etc/cassandra/conf/client_truststore.jks' }),
    client_truststore_password    => lookup('profile_cassandra_pfpt::client_truststore_password', { default_value => 'cassandra' }),
    tls_protocol                  => lookup('profile_cassandra_pfpt::tls_protocol', { default_value => 'TLS' }),
    tls_algorithm                 => lookup('profile_cassandra_pfpt::tls_algorithm', { default_value => 'SunX509' }),
    store_type                    => lookup('profile_cassandra_pfpt::store_type', { default_value => 'JKS' }),
    concurrent_compactors         => lookup('profile_cassandra_pfpt::concurrent_compactors', { default_value => 4 }),
    compaction_throughput_mb_per_sec => lookup('profile_cassandra_pfpt::compaction_throughput_mb_per_sec', { default_value => 16 }),
    tombstone_warn_threshold      => lookup('profile_cassandra_pfpt::tombstone_warn_threshold', { default_value => 1000 }),
    tombstone_failure_threshold   => lookup('profile_cassandra_pfpt::tombstone_failure_threshold', { default_value => 100000 }),
    change_password_cql           => lookup('profile_cassandra_pfpt::change_password_cql', { default_value => 'ALTER USER cassandra WITH PASSWORD \'%s\';' }),
    cqlsh_path_env                => lookup('profile_cassandra_pfpt::cqlsh_path_env', { default_value => '/usr/bin' }),
    dynamic_snitch                => lookup('profile_cassandra_pfpt::dynamic_snitch', { default_value => true }),
    start_native_transport        => lookup('profile_cassandra_pfpt::start_native_transport', { default_value => true }),
    role_manager                  => lookup('profile_cassandra_pfpt::role_manager', { default_value => 'CassandraRoleManager' }),
    cdc_raw_directory             => lookup('profile_cassandra_pfpt::cdc_raw_directory', { default_value => '/var/lib/cassandra/cdc_raw' }),
    commit_failure_policy         => lookup('profile_cassandra_pfpt::commit_failure_policy', { default_value => 'stop' }),
    commitlog_sync                => lookup('profile_cassandra_pfpt::commitlog_sync', { default_value => 'periodic' }),
    disk_failure_policy           => lookup('profile_cassandra_pfpt::disk_failure_policy', { default_value => 'stop' }),
    incremental_backups           => lookup('profile_cassandra_pfpt::incremental_backups', { default_value => false }),
    max_hints_delivery_threads    => lookup('profile_cassandra_pfpt::max_hints_delivery_threads', { default_value => 2 }),
    native_transport_flush_in_batches_legacy => lookup('profile_cassandra_pfpt::native_transport_flush_in_batches_legacy', { default_value => true }),
    native_transport_max_frame_size_in_mb => lookup('profile_cassandra_pfpt::native_transport_max_frame_size_in_mb', { default_value => 256 }),
    range_request_timeout_in_ms   => lookup('profile_cassandra_pfpt::range_request_timeout_in_ms', { default_value => 10000 }),
    read_request_timeout_in_ms    => lookup('profile_cassandra_pfpt::read_request_timeout_in_ms', { default_value => 5000 }),
    request_timeout_in_ms         => lookup('profile_cassandra_pfpt::request_timeout_in_ms', { default_value => 10000 }),
    ssl_storage_port              => lookup('profile_cassandra_pfpt::ssl_storage_port', { default_value => 7001 }),
    storage_port                  => lookup('profile_cassandra_pfpt::storage_port', { default_value => 7000 }),
    truncate_request_timeout_in_ms => lookup('profile_cassandra_pfpt::truncate_request_timeout_in_ms', { default_value => 60000 }),
    write_request_timeout_in_ms   => lookup('profile_cassandra_pfpt::write_request_timeout_in_ms', { default_value => 2000 }),
    commitlog_sync_period_in_ms   => lookup('profile_cassandra_pfpt::commitlog_sync_period_in_ms', { default_value => 10000 }),
    start_rpc                     => lookup('profile_cassandra_pfpt::start_rpc', { default_value => true }),
    rpc_port                      => lookup('profile_cassandra_pfpt::rpc_port', { default_value => 9160 }),
    rpc_keepalive                 => lookup('profile_cassandra_pfpt::rpc_keepalive', { default_value => true }),
    thrift_framed_transport_size_in_mb => lookup('profile_cassandra_pfpt::thrift_framed_transport_size_in_mb', { default_value => 15 }),
    enable_transient_replication  => lookup('profile_cassandra_pfpt::enable_transient_replication', { default_value => false }),
    manage_jmx_security           => lookup('profile_cassandra_pfpt::manage_jmx_security', { default_value => false }),
    jmx_password_file_content     => lookup('profile_cassandra_pfpt::jmx_password_file_content', { default_value => '' }),
    jmx_access_file_content       => lookup('profile_cassandra_pfpt::jmx_access_file_content', { default_value => '' }),
    jmx_password_file_path        => lookup('profile_cassandra_pfpt::jmx_password_file_path', { default_value => '/etc/cassandra/jmxremote.password' }),
    jmx_access_file_path          => lookup('profile_cassandra_pfpt::jmx_access_file_path', { default_value => '/etc/cassandra/jmxremote.access' }),
    service_timeout_start_sec     => lookup('profile_cassandra_pfpt::service_timeout_start_sec', { default_value => '480' }),
    authorizer                    => lookup('profile_cassandra_pfpt::authorizer', { default_value => 'CassandraAuthorizer' }),
    authenticator                 => lookup('profile_cassandra_pfpt::authenticator', { default_value => 'PasswordAuthenticator' }),
    num_tokens                    => lookup('profile_cassandra_pfpt::num_tokens', { default_value => 256 }),
    initial_token                 => lookup('profile_cassandra_pfpt::initial_token', { default_value => undef }),
    endpoint_snitch               => lookup('profile_cassandra_pfpt::endpoint_snitch', { default_value => 'GossipingPropertyFileSnitch' }),
    listen_interface              => lookup('profile_cassandra_pfpt::listen_interface', { default_value => undef }),
    rpc_interface                 => lookup('profile_cassandra_pfpt::rpc_interface', { default_value => undef }),
    broadcast_address             => lookup('profile_cassandra_pfpt::broadcast_address', { default_value => undef }),
    broadcast_rpc_address         => lookup('profile_cassandra_pfpt::broadcast_rpc_address', { default_value => undef }),
    counter_cache_size_in_mb      => lookup('profile_cassandra_pfpt::counter_cache_size_in_mb', { default_value => undef }),
    key_cache_size_in_mb          => lookup('profile_cassandra_pfpt::key_cache_size_in_mb', { default_value => undef }),
    disk_optimization_strategy    => lookup('profile_cassandra_pfpt::disk_optimization_strategy', { default_value => 'ssd' }),
    auto_snapshot                 => lookup('profile_cassandra_pfpt::auto_snapshot', { default_value => true }),
    phi_convict_threshold         => lookup('profile_cassandra_pfpt::phi_convict_threshold', { default_value => 8 }),
    concurrent_reads              => lookup('profile_cassandra_pfpt::concurrent_reads', { default_value => 32 }),
    concurrent_writes             => lookup('profile_cassandra_pfpt::concurrent_writes', { default_value => 32 }),
    concurrent_counter_writes     => lookup('profile_cassandra_pfpt::concurrent_counter_writes', { default_value => 32 }),
    memtable_allocation_type      => lookup('profile_cassandra_pfpt::memtable_allocation_type', { default_value => 'heap_buffers' }),
    index_summary_capacity_in_mb  => lookup('profile_cassandra_pfpt::index_summary_capacity_in_mb', { default_value => undef }),
    file_cache_size_in_mb         => lookup('profile_cassandra_pfpt::file_cache_size_in_mb', { default_value => undef }),
    manage_coralogix_agent        => lookup('profile_cassandra_pfpt::manage_coralogix_agent', { default_value => false }),
    coralogix_api_key             => lookup('profile_cassandra_pfpt::coralogix_api_key', { default_value => '' }),
    coralogix_region              => lookup('profile_cassandra_pfpt::coralogix_region', { default_value => '' }),
    coralogix_logs_enabled        => lookup('profile_cassandra_pfpt::coralogix_logs_enabled', { default_value => false }),
    coralogix_metrics_enabled     => lookup('profile_cassandra_pfpt::coralogix_metrics_enabled', { default_value => false }),
    enable_materialized_views     => lookup('profile_cassandra_pfpt::enable_materialized_views', { default_value => false }),
    coralogix_baseurl             => lookup('profile_cassandra_pfpt::coralogix_baseurl', { default_value => undef }),
    system_keyspaces_replication  => lookup('profile_cassandra_pfpt::system_keyspaces_replication', { default_value => {} }),
    cassandra_roles               => lookup('profile_cassandra_pfpt::cassandra_roles', { default_value => {} }),
    manage_jmx_exporter           => lookup('profile_cassandra_pfpt::manage_jmx_exporter', { default_value => false }),
    jmx_exporter_version          => lookup('profile_cassandra_pfpt::jmx_exporter_version', { default_value => '0.16.1' }),
    jmx_exporter_jar_source       => lookup('profile_cassandra_pfpt::jmx_exporter_jar_source', { default_value => undef }),
    jmx_exporter_jar_target       => lookup('profile_cassandra_pfpt::jmx_exporter_jar_target', { default_value => '/usr/share/cassandra/lib/jmx_prometheus_javaagent.jar' }),
    jmx_exporter_config_source    => lookup('profile_cassandra_pfpt::jmx_exporter_config_source', { default_value => 'puppet:///modules/cassandra_pfpt/jmx-exporter-config.yaml' }),
    jmx_exporter_config_target    => lookup('profile_cassandra_pfpt::jmx_exporter_config_target', { default_value => '/etc/cassandra/jmx-exporter-config.yaml' }),
    jmx_exporter_port             => lookup('profile_cassandra_pfpt::jmx_exporter_port', { default_value => 9400 }),
    manage_full_backups           => lookup('profile_cassandra_pfpt::manage_full_backups', { default_value => false }),
    manage_incremental_backups    => lookup('profile_cassandra_pfpt::manage_incremental_backups', { default_value => false }),
    full_backup_schedule          => lookup('profile_cassandra_pfpt::full_backup_schedule', { default_value => 'daily' }),
    incremental_backup_schedule   => lookup('profile_cassandra_pfpt::incremental_backup_schedule', { default_value => '0 */4 * * *' }),
    backup_s3_bucket              => lookup('profile_cassandra_pfpt::backup_s3_bucket', { default_value => 'your-s3-backup-bucket' }),
    full_backup_script_path       => lookup('profile_cassandra_pfpt::full_backup_script_path', { default_value => '/usr/local/bin/full-backup-to-s3.sh' }),
    incremental_backup_script_path => lookup('profile_cassandra_pfpt::incremental_backup_script_path', { default_value => '/usr/local/bin/incremental-backup-to-s3.sh' }),
    full_backup_log_file          => lookup('profile_cassandra_pfpt::full_backup_log_file', { default_value => '/var/log/cassandra/full_backup.log' }),
    incremental_backup_log_file   => lookup('profile_cassandra_pfpt::incremental_backup_log_file', { default_value => '/var/log/cassandra/incremental_backup.log' }),
    puppet_cron_schedule          => lookup('profile_cassandra_pfpt::puppet_cron_schedule', { default_value => undef }),
    backup_backend                => lookup('profile_cassandra_pfpt::backup_backend', { default_value => 's3' }),
    clearsnapshot_keep_days       => lookup('profile_cassandra_pfpt::clearsnapshot_keep_days', { default_value => 3 }),
    backup_upload_streaming       => lookup('profile_cassandra_pfpt::backup_upload_streaming', { default_value => false }),
    manage_scheduled_repair       => lookup('profile_cassandra_pfpt::manage_scheduled_repair', { default_value => false }),
    repair_schedule               => lookup('profile_cassandra_pfpt::repair_schedule', { default_value => '*-*-1/5 01:00:00' }),
    repair_keyspace               => lookup('profile_cassandra_pfpt::repair_keyspace', { default_value => undef }),
    backup_encryption_key         => $backup_encryption_key,
  }
}
